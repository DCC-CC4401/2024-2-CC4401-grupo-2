<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        
        <title>FoodMap</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    </head>
<body>
   <div class="container" style="margin-top: 2em">
        <!-- Encabezado de la página-->
        <div class="row">
            <div class="col-md-10">
                <h1>FoodMap</h1>
            </div>
            <div class="col-xs-1">
                {% if user.is_authenticated %}
                    {% if user.tipo == "Propietario" %}
                        <!-- aquí añadir la nueva ruta que muestre opción para redirigirse a mis restaurantes -->
                        <a class="badge badge-primary" href="{% url 'register_restaurant' %}">Añadir un restaurante</a>
                        <a class="badge badge-secondary" href="{% url 'logout' %}">Cerrar Sesión</a>

                    {% else %}
                        <a class="badge badge-secondary" href="{% url 'logout' %}"> Cerrar Sesión</a>
                    {% endif %}    
                {% else %}
                    <a class="badge badge-primary" href="{% url 'register_user' %}">Registrarse</a>
                    <a class="badge badge-secondary" href="{% url 'login' %}">Iniciar Sesión</a>
                {% endif %}
            </div>
        </div>
        
        <p class="tagline">Busca tu antojo</p>
        
        <!-- Fin encabezado -->

        <div class="row">
            <div class="col-md-4"> <!-- Columna para la lista de restaurantes -->
                <form method="GET" action="">
                    <label for="comuna">Filtrar por comuna:</label>
                    <select name="comuna" id="comuna" onchange="this.form.submit()" class="form-control">
                        <option value="">Todas las comunas</option>
                        {% for comuna in comunas %}
                            <option value="{{ comuna.id }}" {% if request.GET.comuna == comuna.id|stringformat:"s" %}selected{% endif %}>
                                {{ comuna.nombre }}
                            </option>
                        {% endfor %}
                    </select>

                    <label for="categoria">Filtrar por categoría:</label>
                    <select name="categoria" id="categoria" onchange="this.form.submit()" class="form-control">
                        <option value="">Todas las categorías</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if request.GET.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>
                                {{ categoria.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                    <label for="rating">Filtrar por puntuación:</label>
                    <select name="rating" id="rating" onchange="this.form.submit()" class="form-control">
                        <option value="">Todas las puntuaciones</option>
                        <option value="1-2"{% if request.GET.rating == '1-2' %}selected{% endif %}> [1, 2[ estrellas</option>
                        <option value="2-3"{% if request.GET.rating == '2-3' %}selected{% endif %}> [2, 3[ estrellas</option>
                        <option value="3-4"{% if request.GET.rating == '3-4' %}selected{% endif %}> [3, 4[ estrellas</option>
                        <option value="4-5"{% if request.GET.rating == '4-5' %}selected{% endif %}> [4, 5[ estrellas</option>
                    </select>
                </form>

                <div class="list-group mt-3"> <!-- Lista de restaurantes -->
                    {% for restaurant in restaurantes %}
                        <div class="list-group-item">
                            <h5 class="mb-1">
                                <a href="{% url 'restaurant_detail' restaurant.id %}">
                                    {{ restaurant.name }}
                                </a>
                            </h5>
                            <p class="mb-1"><strong>Dirección:</strong> {{ restaurant.address }}</p>
                            <p class="mb-1"><strong>Teléfono:</strong> {{ restaurant.phone }}</p>
                            <p class="mb-1"><strong>Correo:</strong> {{ restaurant.email }}</p>
                            <p class="mb-1"><strong>Sitio Web:</strong> <a href="{{ restaurant.website }}">{{ restaurant.website }}</a></p>
                            <p class="mb-1"><strong>Descripción:</strong> {{ restaurant.description }}</p>
                            <p class="mb-1"><strong>Categorías:</strong>
                                {% for categoria in restaurant.categorias.all %}
                                    <span class="badge badge-secondary">{{ categoria.nombre }}</span>
                                {% endfor %}
                            </p>
                        </div>
                    {% endfor %}
                </div> <!-- Fin de la lista -->
            </div>

            <div class="col-md-8"> <!-- Columna para el mapa -->
                <div class="text-center" style="margin-top: 2em;">
                    <div id='map' style='width: 400px; height: 300px;'></div>
                        {{ geojson|json_script:'geojson' }}
                        <script defer>
                            const geojson = JSON.parse(document.getElementById('geojson').textContent);
                            mapboxgl.accessToken = "{{ mapbox_access_token }}";
                            
                            var map = new mapboxgl.Map({
                                container: 'map',
                                style: 'mapbox://styles/mapbox/streets-v11',
                                center: [ -70.64827, -33.45694],
                                zoom: 10,
                            });
                            map.on('load', () => {
                                map.addSource('points', {
                                    type: 'geojson',
                                    data: geojson ,
                                }),

                                map.addLayer({
                                    id: 'points',
                                    type: 'circle',
                                    source: 'points',
                                    paint: {
                                    'circle-radius': 10,
                                    'circle-color': '#007cbf',
                                    }
                                })
                            });
                            
                            console.log(geojson);
                        </script>
                        
                        

                </div>
            </div> <!-- Fin de la columna -->
        </div> <!-- Fin de la fila -->
    </div><!-- container -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>
</html>


